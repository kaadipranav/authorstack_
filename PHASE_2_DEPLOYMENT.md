# Phase 2 Deployment Guide

## âœ… Build Status
**Build completed successfully** - All TypeScript errors resolved, production bundle ready.

---

## SQL Queries for Supabase SQL Editor

Copy and paste the following SQL into your Supabase SQL Editor and execute:

```sql
-- ============================================================================
-- Phase 2: Analytics, Funnel, and Pricing Extensions
-- Backward-compatible additions to existing schema
-- ============================================================================

-- Book Analytics Aggregations
-- Pre-computed daily/weekly/monthly sales aggregations per book
-- Allows fast queries for date-range filtering without scanning all sales_events

CREATE TABLE IF NOT EXISTS public.book_analytics_daily (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id UUID NOT NULL REFERENCES public.profiles (id) ON DELETE CASCADE,
  book_id UUID REFERENCES public.books (id) ON DELETE CASCADE,
  date DATE NOT NULL,
  revenue NUMERIC(12,2) NOT NULL DEFAULT 0,
  units_sold INTEGER NOT NULL DEFAULT 0,
  platform TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now()),
  UNIQUE (book_id, date, platform)
);

CREATE INDEX IF NOT EXISTS book_analytics_daily_book_idx ON public.book_analytics_daily (book_id, date DESC);
CREATE INDEX IF NOT EXISTS book_analytics_daily_profile_idx ON public.book_analytics_daily (profile_id, date DESC);

-- ============================================================================
-- Reader Funnel Events
-- Manual tracking of impressions â†’ clicks â†’ conversions
-- Phase 2: Manual entry only; Phase 3+: Automated tracking via pixels/webhooks
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.funnel_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id UUID NOT NULL REFERENCES public.profiles (id) ON DELETE CASCADE,
  book_id UUID REFERENCES public.books (id) ON DELETE SET NULL,
  event_type TEXT NOT NULL CHECK (event_type IN ('impression', 'click', 'conversion')),
  source TEXT NOT NULL, -- e.g., 'facebook_ad', 'email_campaign', 'organic'
  metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
  occurred_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now()),
  created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now())
);

CREATE INDEX IF NOT EXISTS funnel_events_profile_idx ON public.funnel_events (profile_id, occurred_at DESC);
CREATE INDEX IF NOT EXISTS funnel_events_book_idx ON public.funnel_events (book_id, event_type, occurred_at);

-- ============================================================================
-- Pricing History & Recommendations
-- Tracks price changes over time for each book
-- Enables rule-based pricing suggestions
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.pricing_snapshots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id UUID NOT NULL REFERENCES public.profiles (id) ON DELETE CASCADE,
  book_id UUID NOT NULL REFERENCES public.books (id) ON DELETE CASCADE,
  platform TEXT NOT NULL,
  price NUMERIC(10,2) NOT NULL,
  currency TEXT NOT NULL DEFAULT 'USD',
  snapshot_date DATE NOT NULL DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now())
);

CREATE INDEX IF NOT EXISTS pricing_snapshots_book_idx ON public.pricing_snapshots (book_id, snapshot_date DESC);
CREATE INDEX IF NOT EXISTS pricing_snapshots_platform_idx ON public.pricing_snapshots (book_id, platform, snapshot_date DESC);

-- ============================================================================
-- Pricing Recommendations Cache
-- Rule-based suggestions generated by pricing helper
-- Cached to avoid recalculation on every page load
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.pricing_recommendations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_id UUID NOT NULL REFERENCES public.profiles (id) ON DELETE CASCADE,
  book_id UUID NOT NULL REFERENCES public.books (id) ON DELETE CASCADE,
  recommendation_type TEXT NOT NULL CHECK (recommendation_type IN ('increase', 'decrease', 'revert', 'maintain')),
  suggested_price NUMERIC(10,2),
  reasoning TEXT NOT NULL,
  metadata JSONB NOT NULL DEFAULT '{}'::jsonb,
  generated_at TIMESTAMPTZ NOT NULL DEFAULT timezone('utc'::text, now()),
  expires_at TIMESTAMPTZ NOT NULL DEFAULT (timezone('utc'::text, now()) + INTERVAL '24 hours')
);

CREATE INDEX IF NOT EXISTS pricing_recommendations_book_idx ON public.pricing_recommendations (book_id, generated_at DESC);
CREATE INDEX IF NOT EXISTS pricing_recommendations_expires_idx ON public.pricing_recommendations (expires_at);

-- ============================================================================
-- Helper Views for Common Queries
-- ============================================================================

-- Aggregate book analytics by week
CREATE OR REPLACE VIEW public.book_analytics_weekly AS
SELECT
  book_id,
  profile_id,
  platform,
  DATE_TRUNC('week', date) AS week_start,
  SUM(revenue) AS revenue,
  SUM(units_sold) AS units_sold
FROM public.book_analytics_daily
GROUP BY book_id, profile_id, platform, week_start;

-- Aggregate book analytics by month
CREATE OR REPLACE VIEW public.book_analytics_monthly AS
SELECT
  book_id,
  profile_id,
  platform,
  DATE_TRUNC('month', date) AS month_start,
  SUM(revenue) AS revenue,
  SUM(units_sold) AS units_sold
FROM public.book_analytics_daily
GROUP BY book_id, profile_id, platform, month_start;

-- Funnel conversion rates
CREATE OR REPLACE VIEW public.funnel_conversion_summary AS
SELECT
  profile_id,
  book_id,
  source,
  COUNT(*) FILTER (WHERE event_type = 'impression') AS impressions,
  COUNT(*) FILTER (WHERE event_type = 'click') AS clicks,
  COUNT(*) FILTER (WHERE event_type = 'conversion') AS conversions,
  CASE
    WHEN COUNT(*) FILTER (WHERE event_type = 'impression') > 0
    THEN (COUNT(*) FILTER (WHERE event_type = 'click')::NUMERIC / COUNT(*) FILTER (WHERE event_type = 'impression')) * 100
    ELSE 0
  END AS click_through_rate,
  CASE
    WHEN COUNT(*) FILTER (WHERE event_type = 'click') > 0
    THEN (COUNT(*) FILTER (WHERE event_type = 'conversion')::NUMERIC / COUNT(*) FILTER (WHERE event_type = 'click')) * 100
    ELSE 0
  END AS conversion_rate
FROM public.funnel_events
GROUP BY profile_id, book_id, source;

-- ============================================================================
-- Cleanup Function for Expired Recommendations
-- ============================================================================

CREATE OR REPLACE FUNCTION public.cleanup_expired_pricing_recommendations()
RETURNS void AS $$
BEGIN
  DELETE FROM public.pricing_recommendations
  WHERE expires_at < timezone('utc'::text, now());
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- OPTIONAL: Seed Analytics Data from Existing Sales Events
-- Run this AFTER the schema is created to populate historical data
-- ============================================================================

-- Uncomment and run if you have existing sales_events data:
-- INSERT INTO public.book_analytics_daily (profile_id, book_id, date, revenue, units_sold, platform)
-- SELECT 
--   profile_id, 
--   book_id, 
--   DATE(occurred_at) AS date,
--   SUM(amount) AS revenue,
--   SUM(quantity) AS units_sold,
--   platform
-- FROM public.sales_events
-- WHERE book_id IS NOT NULL
-- GROUP BY profile_id, book_id, DATE(occurred_at), platform
-- ON CONFLICT (book_id, date, platform) DO NOTHING;
```

---

## Deployment Checklist

### âœ… Pre-Deployment

- [x] TypeScript compilation successful
- [x] Production build successful (`pnpm build`)
- [x] All Phase 2 routes generated correctly
- [x] No breaking changes to Phase 1 functionality

### ðŸ“‹ Deployment Steps

1. **Run SQL Migration** (above) in Supabase SQL Editor
2. **Verify Tables Created:**
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public' 
   AND table_name IN (
     'book_analytics_daily', 
     'funnel_events', 
     'pricing_snapshots', 
     'pricing_recommendations'
   );
   ```

3. **Verify Views Created:**
   ```sql
   SELECT table_name FROM information_schema.views 
   WHERE table_schema = 'public' 
   AND table_name IN (
     'book_analytics_weekly',
     'book_analytics_monthly', 
     'funnel_conversion_summary'
   );
   ```

4. **Set Environment Variables** (if not already set):
   ```env
   NEXT_PUBLIC_APP_URL=https://your-domain.com
   NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
   ```

5. **Deploy to Vercel:**
   ```bash
   git add .
   git commit -m "feat: Phase 2 - Analytics, Funnel, and Pricing"
   git push origin master
   ```

6. **Post-Deployment Verification:**
   - Visit `/dashboard/analytics` - should render empty state
   - Visit `/dashboard/funnel` - should render empty state
   - Test API endpoints:
     - `GET /api/analytics?granularity=daily`
     - `POST /api/funnel` with sample data
     - `GET /api/pricing?bookId=<uuid>`

---

## New Routes Available

### Dashboard Pages
- `/dashboard/analytics` - Book analytics overview
- `/dashboard/funnel` - Reader funnel tracking
- `/dashboard/books/[bookId]/pricing` - Per-book pricing analysis

### API Endpoints
- `GET /api/analytics` - Fetch analytics with filters
- `GET /api/funnel` - Fetch funnel metrics
- `POST /api/funnel` - Record funnel events
- `GET /api/pricing` - Get pricing recommendations

---

## Testing Sample Data

### Insert Test Sales Events (if needed)
```sql
-- Insert sample book
INSERT INTO public.books (profile_id, title, format, status)
VALUES (
  '<your-profile-id>', 
  'Test Book', 
  'ebook', 
  'live'
) RETURNING id;

-- Insert sample sales (use book_id from above)
INSERT INTO public.sales_events (profile_id, book_id, platform, event_type, quantity, amount, currency, occurred_at)
VALUES 
  ('<profile-id>', '<book-id>', 'amazon_kdp', 'sale', 5, 49.95, 'USD', NOW() - INTERVAL '10 days'),
  ('<profile-id>', '<book-id>', 'amazon_kdp', 'sale', 3, 29.97, 'USD', NOW() - INTERVAL '5 days'),
  ('<profile-id>', '<book-id>', 'gumroad', 'sale', 2, 19.98, 'USD', NOW() - INTERVAL '2 days');

-- Aggregate into analytics
INSERT INTO public.book_analytics_daily (profile_id, book_id, date, revenue, units_sold, platform)
SELECT 
  profile_id, 
  book_id, 
  DATE(occurred_at) AS date,
  SUM(amount) AS revenue,
  SUM(quantity) AS units_sold,
  platform
FROM public.sales_events
WHERE book_id = '<book-id>'
GROUP BY profile_id, book_id, DATE(occurred_at), platform;
```

### Insert Test Funnel Events
```sql
INSERT INTO public.funnel_events (profile_id, book_id, event_type, source, occurred_at)
VALUES
  ('<profile-id>', '<book-id>', 'impression', 'facebook_ad', NOW() - INTERVAL '5 days'),
  ('<profile-id>', '<book-id>', 'impression', 'facebook_ad', NOW() - INTERVAL '4 days'),
  ('<profile-id>', '<book-id>', 'click', 'facebook_ad', NOW() - INTERVAL '3 days'),
  ('<profile-id>', '<book-id>', 'conversion', 'facebook_ad', NOW() - INTERVAL '2 days');
```

---

## Monitoring & Maintenance

### Scheduled Cleanup (Optional)
Set up a cron job or QStash job to clean expired recommendations:

```sql
-- Run daily at 2 AM UTC
SELECT public.cleanup_expired_pricing_recommendations();
```

### Performance Monitoring
- Monitor query performance on `book_analytics_daily` table
- If aggregations become slow, consider materialized views
- Index tuning may be needed as data grows

---

## Rollback Plan (if needed)

If you need to rollback Phase 2:

```sql
-- Drop tables and views (in reverse dependency order)
DROP VIEW IF EXISTS public.funnel_conversion_summary;
DROP VIEW IF EXISTS public.book_analytics_monthly;
DROP VIEW IF EXISTS public.book_analytics_weekly;
DROP FUNCTION IF EXISTS public.cleanup_expired_pricing_recommendations();
DROP TABLE IF EXISTS public.pricing_recommendations;
DROP TABLE IF EXISTS public.pricing_snapshots;
DROP TABLE IF EXISTS public.funnel_events;
DROP TABLE IF EXISTS public.book_analytics_daily;
```

**Note:** This will delete all Phase 2 data. Phase 1 features will continue working normally.

---

## Support & Documentation

- **Architecture:** See `docs/PHASE_2_ARCHITECTURE.md`
- **API Docs:** Detailed in architecture document
- **Component Docs:** All components include inline JSDoc

---

**Phase 2 is production-ready and backward-compatible with Phase 1.**
